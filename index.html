<!doctype html>
<html lang='en'>
    <head>
        <meta charset='utf-8'>
        <meta http-equiv='X-UA-Compatible' content='IE=edge'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>
        <title>Hart ECG</title>

        <style>
            body {
                margin: 0;
                font-family: 'Roboto', 'Noto', sans-serif;
                background-color: #f7f7f7;
            }
        </style>
        <script type="text/javascript" src="moment.min.js"></script>
        <script type="text/javascript" src="Chart.min.js"></script>
        <script type="text/javascript" src="chartjs-plugin-streaming.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
    </head>

    <body>
        <canvas id="myChart"></canvas>
        <script>
            ////////////////////////////////////////////////////////////////////////// setup database
            var config = {
                apiKey: "AIzaSyBJS638LrDtlTwbRC8BZexAA4MUXR9E-hU",
                authDomain: "hart-ecg.firebaseapp.com",
                databaseURL: "https://hart-ecg.firebaseio.com",
                projectId: "hart-ecg",
                storageBucket: "hart-ecg.appspot.com",
                messagingSenderId: "522285262446"
            };
            firebase.initializeApp(config);
            var database = firebase.database();
            var ecgRef = database.ref('ecg');

            var signalData = [];

            ecgRef.orderByKey().startAt((Math.floor((new Date).getTime()/1000)).toString()).on('child_added', (childSnapshot, prevChildKey) => {
                var newSignalLength = childSnapshot.val().length;
                childSnapshot.val().forEach(signalValue => {
                    signalData.unshift(signalValue);
                });
            });

            ////////////////////////////////////////////////////////////////////////// setup graph
            var ctx = document.getElementById('myChart').getContext('2d');
            var chart = new Chart(ctx, {
                type: 'line',

                data: {
                    datasets: [{
                        label: "Heart Signal",
                        borderColor: 'rgba(211,37,52,0.5)',
                        radius: 0,
                        fill: 0,
                        data: []
                    }]
                },

                options: {
                    layout: {
                        padding: {
                            left: 0
                        }
                    },
                    legend: {
                        display: false
                    },
                    scales: {
                        yAxes: [{
                            display: false
                        }],
                        xAxes: [{
                            type: 'realtime'
                        }]
                    },
                    plugins: {
                        streaming: {
                            refresh: 20,
                            duration: 10000,
                            frameRate: 30,
                            delay: 40,
                            onRefresh: function(chart) {
                                chart.data.datasets[0].data.push({
                                    x: Date.now(),
                                    y: signalData.pop()
                                });
                            }
                        }
                    }
                }
            });
        </script>
    </body>
</html>